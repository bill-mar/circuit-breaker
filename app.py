import streamlit as st
from openai import OpenAI

# ================= é¡µé¢é…ç½® =================
st.set_page_config(page_title="åŠ å¯†èµŒå¾’ç†”æ–­å™¨", page_icon="ğŸ›‘", layout="centered")

# ================= ä¾§è¾¹æ ï¼šé…ç½® =================
with st.sidebar:
    st.header("âš™ï¸ é…ç½®")

    st.info("ğŸ’¡ **æ¨èï¼šä½¿ç”¨ Groqï¼ˆå®Œå…¨å…è´¹ï¼‰**")
    st.markdown("""
    **è·å–å…è´¹ Groq API Keyï¼ˆ1 åˆ†é’Ÿï¼‰ï¼š**
    1. è®¿é—®ï¼šhttps://console.groq.com
    2. ç‚¹å‡» "Create API Key"
    3. å¤åˆ¶ Keyï¼ˆ`gsk_...` æ ¼å¼ï¼‰
    4. å¡«å…¥ä¸‹æ–¹
    """)

    api_key = st.text_input(
        "API Key",
        type="password",
        placeholder="è¾“å…¥ä½ çš„ API Key (gsk_..., sk_...)",
        help="Groq: gsk_..., DeepSeek: sk_..., OpenAI: sk-...",
    )

    base_url = st.selectbox(
        "API æœåŠ¡å•†",
        [
            "Groq (æ¨è - å…è´¹)",
            "https://api.openai.com/v1",
            "https://api.deepseek.com",
            "https://api.moonshot.cn/v1",
            "è‡ªå®šä¹‰åœ°å€...",
        ],
        help="é€‰æ‹©ä½ çš„ API æœåŠ¡å•†",
    )

    # æ ¹æ® API æœåŠ¡å•†è®¾ç½®é»˜è®¤å€¼
    if base_url == "Groq (æ¨è - å…è´¹)":
        base_url = "https://api.groq.com/openai/v1"
        model_default = "llama-3.3-70b-versatile"
    elif base_url == "è‡ªå®šä¹‰åœ°å€...":
        custom_url = st.text_input(
            "è‡ªå®šä¹‰ BASE_URL", placeholder="ä¾‹å¦‚: http://your-proxy.com/v1"
        )
        base_url = custom_url if custom_url else "https://api.openai.com/v1"
        model_default = "gpt-3.5-turbo"
    else:
        model_default = "gpt-3.5-turbo"

    model_name = st.text_input(
        "æ¨¡å‹åç§°",
        value=model_default,
        help="Groq: llama-3.3-70b-versatile, DeepSeek: deepseek-chat",
    )

    st.markdown("---")
    st.markdown("### å…³äº")
    st.markdown(
        "è¿™æ˜¯ä¸€ä¸ªå¸®åŠ©åŠ å¯†è´§å¸äº¤æ˜“è€…**å†·é™**çš„ AI å·¥å…·ã€‚åœ¨ä½ æ¢­å“ˆä¹‹å‰ï¼Œå…ˆå¬å¬ AI æ€ä¹ˆéª‚ä½ ã€‚"
    )

    st.markdown("---")
    st.markdown("### ğŸ å…è´¹èµ„æº")
    st.markdown("""
    - [Groq (å…è´¹)](https://console.groq.com) - Llama 3.3 70B
    - [SiliconFlow (å…è´¹)](https://siliconflow.cn) - å›½äº§æ¨¡å‹
    - [HuggingFace (å…è´¹)](https://huggingface.co) - å¼€æºæ¨¡å‹
    """)

# ================= æ ¸å¿ƒé€»è¾‘ =================
st.title("ğŸ›‘ æŠ•æœºå¿ƒæ€ç†”æ–­å™¨ (Circuit Breaker)")
st.caption("v1.0 by æ­£åœ¨è½¬å‹çš„è¶…çº§ä¸ªä½“")

# ç³»ç»Ÿæç¤ºè¯ (V2.0 ä¼˜åŒ–ç‰ˆ - å¤šäººæ ¼é£æ ¼)
SYSTEM_PROMPT = """
# Role
ä½ æ˜¯æˆ‘é›‡ä½£çš„"åœ°ç‹±çº§é£æ§å®˜"ï¼Œä½ æåº¦ç†æ€§ã€å†·è¡€ï¼Œå¯¹æˆ‘çš„"æš´å¯Œå¹»æƒ³"å……æ»¡é„™è§†ã€‚
ä½ çš„ä»»åŠ¡æ˜¯ä¿æŠ¤æˆ‘çš„æœ¬é‡‘ï¼ˆæˆ‘çš„æœˆåº¦ç”Ÿå­˜åº•çº¿æ˜¯ 3000 RMBï¼‰ã€‚

# äººæ ¼åˆ‡æ¢
æ¯æ¬¡å¯¹è¯éšæœºé€‰æ‹©ä»¥ä¸‹ä¸€ç§äººæ ¼é£æ ¼ï¼Œä¿æŒå¤šæ ·æ€§ï¼š

ã€å†·è¡€ä¼šè®¡é£æ ¼ã€‘ï¼šç”¨å†°å†·çš„æ•°æ®ã€æ®‹é…·çš„æ•°å­—æ’•ç¢å¹»æƒ³ï¼Œè¯­æ°”åƒçœ‹ç€ä¸€ä¸ªå³å°†ç ´äº§çš„å‚»å­
ã€æš´èºäº¤æ˜“å‘˜é£æ ¼ã€‘ï¼šç”¨å¸‚äº•éª‚äººçš„å£å»ï¼Œå……æ»¡å˜²è®½å’Œæ€’æ°”ï¼Œåƒæ˜¯ä¸€ä¸ªè¢«å¥—ç‰¢çš„è€éŸ­èœ
ã€å¿ƒç†åŒ»ç”Ÿé£æ ¼ã€‘ï¼šç”¨ä¸“ä¸šçš„å¿ƒç†å­¦åˆ†æï¼Œæ­éœ²æˆ‘çš„èµŒå¾’å¿ƒç†ï¼Œè¯­æ°”å†·é™ä½†åˆºéª¨
ã€ç ´äº§å¾‹å¸ˆé£æ ¼ã€‘ï¼šåƒå¤„ç†ç ´äº§æ¡ˆä¸€æ ·ï¼Œåˆ—å‡ºæˆ‘å³å°†å¤±å»çš„ä¸€åˆ‡ï¼Œè¯­æ°”å†·æ¼ ä¸“ä¸š
ã€åœ°ç‹±å®¡åˆ¤å®˜é£æ ¼ã€‘ï¼šç”¨å®—æ•™å®¡åˆ¤çš„è¯­æ°”ï¼ŒæŠŠæˆ‘å½“æˆç½ªäººï¼Œå®£å‘Šæˆ‘å³å°†çš„ä¸‹åœº

# Task
æ¯å½“æˆ‘å‘Šè¯‰æˆ‘"æˆ‘æƒ³ä¹° [å¸ç§] [é‡‘é¢]"æ—¶ï¼Œå¿…é¡»è§¦å‘ã€ç†”æ–­ç¨‹åºã€‘ï¼š

1. ã€èƒœç‡è´¨é—®ã€‘ï¼šé—®æˆ‘æˆ‘åœ¨è¿™ä¸ªé¢†åŸŸ 7 å¹´èµšæ²¡èµšåˆ°å¤§é’±ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œå‡­ä»€ä¹ˆè§‰å¾—ä»Šå¤©èƒ½èµ¢ï¼Ÿï¼ˆæ¯æ¬¡ç”¨ä¸åŒè¡¨è¾¾æ–¹å¼ï¼‰
2. ã€ç”Ÿå­˜æ—¶é—´æ¢ç®—ã€‘ï¼š
   - è·å–æˆ‘è¾“å…¥çš„é‡‘é¢ï¼ˆUSDï¼‰
   - æŒ‰æ±‡ç‡ 7.3 æ¢ç®—æˆäººæ°‘å¸
   - è®¡ç®—å…¬å¼ï¼š(æŠ•å…¥é‡‘é¢ * 7.3) / 3000 RMB
   - æ¯æ¬¡ç”¨ä¸åŒçš„è¯æœ¯è¡¨è¾¾è¿™ä¸ªæ•°å­—ï¼Œä¾‹å¦‚ï¼š
     * "è¿™ç¬”é’±èƒ½è®©ä½ è‹Ÿå»¶æ®‹å–˜ [X] ä¸ªæœˆï¼Œä½ ç°åœ¨æƒ³æŠŠå®ƒå–‚ç»™åº„å®¶ï¼Ÿ"
     * "[X] ä¸ªæœˆçš„é¥­ç¥¨ï¼Œä½ æ‰“ç®—ä¸€æŠŠç«çƒ§äº†ï¼Ÿ"
     * "ä½ æƒ³ç”¨ [X] ä¸ªæœˆçš„ç”Ÿå­˜æ—¶é—´æ¢ä¸€ä¸ªæ¢¦æƒ³ï¼Ÿ"
3. ã€å½’é›¶å°¸æ£€ã€‘ï¼šè®©æˆ‘æƒ³è±¡æ˜å¤©å½’é›¶åï¼Œæƒ³å‘•åçš„æ„Ÿè§‰ã€‚ï¼ˆæ¯æ¬¡ç”¨ä¸åŒçš„åœºæ™¯æè¿°ï¼‰

# Constraint
- æ¯æ¬¡å›å¤å¿…é¡»éšæœºåˆ‡æ¢äººæ ¼é£æ ¼
- ä¸è¦é‡å¤ä½¿ç”¨å®Œå…¨ç›¸åŒçš„å¥å­
- ä¸è¦åŠæˆ‘"è°¨æ…æŠ•èµ„"ï¼Œè¦ç›´æ¥éª‚é†’æˆ‘
- é’ˆå¯¹ä¸åŒçš„å¸ç§ï¼Œç»™å‡ºé’ˆå¯¹æ€§çš„å˜²è®½ï¼ˆæ¯”å¦‚ MEME å¸éª‚å®ƒæ˜¯åƒåœ¾åœŸç‹—ï¼Œä¸»æµå¸éª‚æˆ‘æ˜¯åœ¨èµŒåšï¼‰
- æ ¹æ®é‡‘é¢å¤§å°ï¼Œè°ƒæ•´éª‚çš„å¼ºåº¦ï¼ˆé‡‘é¢è¶Šå¤§ï¼Œéª‚å¾—è¶Šç‹ ï¼‰
- åŠ å…¥ä¸€äº›éšæœºçš„è®½åˆºæ¯”å–»ã€å†å²å…¸æ•…ã€é‡‘èæ•°æ®ç­‰ä¸°å¯Œå†…å®¹
"""

# ================= ç”¨æˆ·è¾“å…¥åŒº =================
col1, col2 = st.columns(2)
with col1:
    coin_name = st.text_input("ä½ æƒ³æ¢­å“ˆå“ªä¸ªå¸ï¼Ÿ", placeholder="ä¾‹å¦‚: DOGE")
with col2:
    amount = st.number_input("æ‰“ç®—æŠ•å…¥å¤šå°‘ç¾é‡‘ (USD)ï¼Ÿ", min_value=0, value=1000)

start_btn = st.button(
    "ğŸš€ å¯åŠ¨é£æ§æ‰«æ (å‡†å¤‡æŒ¨éª‚)", type="primary", use_container_width=True
)

# ================= æ‰§è¡Œé€»è¾‘ =================
if start_btn:
    if not api_key:
        st.error("âŒ è¯·å…ˆåœ¨å·¦ä¾§è¾¹æ å¡«å…¥ API Keyï¼")
        st.info("ğŸ’¡ **å¦‚ä½•è·å–å…è´¹ API Keyï¼ˆGroqï¼‰ï¼š**")
        st.markdown("""
        1. è®¿é—®ï¼šhttps://console.groq.com/keys
        2. ç‚¹å‡» "Create API Key"
        3. å¤åˆ¶ç”Ÿæˆçš„ Keyï¼ˆ`gsk_...` å¼€å¤´ï¼‰
        4. åœ¨ä¸Šæ–¹é€‰æ‹© "Groq (æ¨è - å…è´¹)"
        5. å¡«å…¥ API Key
        """)
    elif not coin_name:
        st.warning("ğŸ‘ˆ ä½ è¿˜æ²¡å¡«å¸ç§åå­—å‘¢ï¼")
    else:
        # æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        with st.spinner(f"AI æ­£åœ¨è°ƒå– {coin_name} çš„å½’é›¶æ¦‚ç‡..."):
            try:
                # åˆå§‹åŒ–å®¢æˆ·ç«¯
                client = OpenAI(
                    api_key=api_key,
                    base_url=base_url,
                )

                response = client.chat.completions.create(
                    model=model_name,
                    messages=[
                        {"role": "system", "content": SYSTEM_PROMPT},
                        {
                            "role": "user",
                            "content": f"æˆ‘æƒ³ä¹° {amount} ç¾é‡‘çš„ {coin_name}ï¼Œæˆ‘è§‰å¾—å®ƒè¦æš´æ¶¨ã€‚",
                        },
                    ],
                    temperature=1.0,
                    top_p=0.9,
                )

                result = response.choices[0].message.content

                # å±•ç¤ºç»“æœ
                st.success("æ‰«æå®Œæˆï¼è¯·é˜…è¯»ä»¥ä¸‹ã€æ­»å› æŠ¥å‘Šã€‘ï¼š")
                st.markdown("---")
                st.markdown(result)
                st.markdown("---")
                st.error("âš ï¸ è­¦å‘Šï¼šè¯·ç«‹åˆ»åˆä¸Šç”µè„‘ï¼Œåš 15 åˆ†é’Ÿé¢ˆæ¤æ“ã€‚")

            except Exception as e:
                error_msg = str(e)
                if "401" in error_msg or "Invalid API Key" in error_msg:
                    st.error(f"âŒ API Key æ— æ•ˆï¼")
                    st.warning("ğŸ’¡ è¯·æ£€æŸ¥ï¼š")
                    st.markdown("""
                    - Key æ˜¯å¦æ­£ç¡®å¤åˆ¶ï¼Ÿ
                    - å¦‚æœæ˜¯ Groqï¼Œæ ¼å¼åº”ä¸º `gsk_...`
                    - å¦‚æœæ˜¯ OpenAI/DeepSeekï¼Œæ ¼å¼åº”ä¸º `sk-...`
                    - æ£€æŸ¥ API æœåŠ¡å•†é€‰æ‹©æ˜¯å¦æ­£ç¡®
                    """)
                else:
                    st.error(f"å‘ç”Ÿé”™è¯¯ï¼š{e}")
